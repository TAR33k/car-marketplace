<div class="container">
  <h2 *ngIf="advertisementId!=0">Edit Advertisement</h2>
  <h2 *ngIf="advertisementId==0">Add new Advertisement</h2>

  <form (ngSubmit)="updateAdvertisement()">
    <!-- Advertisement Details -->
    <div class="section">
      <h3>Advertisement Details</h3>

      <div class="form-group">
        <label for="title">Title:</label>
        <input class="form-control" [(ngModel)]="advertisement.title" id="title" name="title" required/>
      </div>

      <div class="form-group">
        <label for="description">Description:</label>
        <textarea class="form-control" [(ngModel)]="advertisement.description" id="description" name="description" rows="4"></textarea>
      </div>

      <div class="form-group">
        <label for="condition">Condition:</label>
        <select class="form-control" [(ngModel)]="advertisement.condition" id="condition" name="condition" required>
          <option [ngValue]="null">Select condition</option>
          <option *ngFor="let condition of conditions" [ngValue]="condition">
            {{condition}}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label for="price">Price:</label>
        <input class="form-control" type="number" [(ngModel)]="advertisement.price" id="price" name="price" required/>
      </div>

      <div class="form-group">
        <label for="expirationDate">Expiration Date:</label>
        <input
          class="form-control"
          type="date"
          [ngModel]="formatDateForInput(advertisement.expirationDate)"
          (ngModelChange)="onExpirationDateChange($event)"
          id="expirationDate"
          name="expirationDate"/>
      </div>
    </div>

    <!-- Car Details Section -->
    <div class="section">
      <h3>Car Details</h3>

      <!-- Show car selection options only for new advertisements -->
      <div *ngIf="advertisementId === 0">
        <div class="form-group">
          <div class="car-selection-mode">
            <div class="form-check">
              <input class="form-check-input" type="radio" id="existingCar" name="carMode"
                     [checked]="!isNewCar" (change)="toggleCarMode()">
              <label class="form-check-label" for="existingCar">Select Existing Car</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" id="newCar" name="carMode"
                     [checked]="isNewCar" (change)="toggleCarMode()">
              <label class="form-check-label" for="newCar">Create New Car</label>
            </div>
          </div>
        </div>

        <!-- Existing Car Selection -->
        <div *ngIf="!isNewCar" class="form-group">
          <label for="carId">Select Car:</label>
          <select class="form-control" [(ngModel)]="advertisement.carId" id="carId" name="carId" required>
            <option [ngValue]="0">Select a car</option>
            <option *ngFor="let car of cars" [ngValue]="car.id">
              {{ car.name }} - {{ car.year }} {{ car.manufacturerName }} {{ car.modelName }}
            </option>
          </select>

          <small class="text-muted" *ngIf="cars.length === 0">
            No available cars found. All cars are currently linked to advertisements.
            Please create a new car or free up an existing one.
          </small>

          <small class="text-info" *ngIf="cars.length > 0">
            Showing {{ cars.length }} available car(s)
          </small>
        </div>

        <!-- New Car Form -->
        <div *ngIf="isNewCar" class="new-car-form">
          <div class="form-group">
            <label for="carName">Car Name:</label>
            <input class="form-control" [(ngModel)]="newCar.name" id="carName" name="carName" required/>
          </div>

          <div class="form-group">
            <label for="manufacturer">Manufacturer:</label>
            <select class="form-control" [(ngModel)]="selectedManufacturerId"
                    (ngModelChange)="onManufacturerChange($event)"
                    id="manufacturer" name="manufacturer" required>
              <option [ngValue]="0">Select manufacturer</option>
              <option *ngFor="let manufacturer of manufacturers" [ngValue]="manufacturer.id">
                {{manufacturer.name}}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="modelID">Model:</label>
            <select class="form-control" [(ngModel)]="newCar.modelID"
                    id="modelID" name="modelID" required
                    [disabled]="!selectedManufacturerId">
              <option [ngValue]="0">Select model</option>
              <option *ngFor="let model of models" [ngValue]="model.id">
                {{model.name}}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="carYear">Year:</label>
            <input class="form-control" type="number" [(ngModel)]="newCar.year"
                   id="carYear" name="carYear" required
                   [min]="1900" [max]="currentYear"/>
          </div>

          <div class="form-group">
            <label for="engineCapacity">Engine Capacity (L):</label>
            <input class="form-control" type="number" [(ngModel)]="newCar.engineCapacity"
                   id="engineCapacity" name="engineCapacity" required
                   step="0.1" min="0.1" max="10"/>
          </div>

          <div class="form-group">
            <label for="fuelType">Fuel Type:</label>
            <select class="form-control" [(ngModel)]="newCar.fuelType" id="fuelType" name="fuelType" required>
              <option [ngValue]="null">Select fuel type</option>
              <option *ngFor="let type of fuelTypes" [ngValue]="type">
                {{getFuelTypeName(type)}}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="transmission">Transmission:</label>
            <select class="form-control" [(ngModel)]="newCar.transmission" id="transmission" name="transmission" required>
              <option [ngValue]="null">Select transmission</option>
              <option *ngFor="let type of transmissionTypes" [ngValue]="type">
                {{getTransmissionTypeName(type)}}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="doors">Number of Doors:</label>
            <input class="form-control" type="number" [(ngModel)]="newCar.doors"
                   id="doors" name="doors" required min="2" max="8"/>
          </div>

          <div class="form-group">
            <label for="fuelConsumption">Fuel Consumption (L/100km):</label>
            <input class="form-control" type="number" [(ngModel)]="newCar.fuelConsumption"
                   id="fuelConsumption" name="fuelConsumption" required
                   step="0.1" min="0" max="30"/>
          </div>

          <div class="form-group">
            <label for="mileage">Mileage (km):</label>
            <input class="form-control" type="number" [(ngModel)]="newCar.mileage"
                   id="mileage" name="mileage" required min="0"/>
          </div>

          <div class="form-group">
            <label for="color">Color:</label>
            <input class="form-control" [(ngModel)]="newCar.color" id="color" name="color" required/>
          </div>

          <div class="form-group">
            <label for="bodyID">Body Type:</label>
            <select class="form-control" [(ngModel)]="newCar.bodyID" id="bodyID" name="bodyID" required>
              <option [ngValue]="0">Select body type</option>
              <option *ngFor="let type of bodyTypes" [ngValue]="type.id">{{type.name}}</option>
            </select>
          </div>

          <div class="form-group">
            <label for="cityID">City:</label>
            <select class="form-control" [(ngModel)]="newCar.cityID" id="cityID" name="cityID" required>
              <option [ngValue]="0">Select city</option>
              <option *ngFor="let city of cities" [ngValue]="city.id">{{city.name}}</option>
            </select>
          </div>

          <div class="form-group">
            <div class="form-check">
              <input class="form-check-input" type="checkbox"
                     [(ngModel)]="newCar.hasServiceHistory"
                     id="hasServiceHistory" name="hasServiceHistory">
              <label class="form-check-label" for="hasServiceHistory">Has Service History</label>
            </div>
          </div>
        </div>
      </div>

      <!-- Show car details when editing -->
      <div *ngIf="advertisementId !== 0 && currentCar" class="car-details">
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label>Car Name:</label>
              <input class="form-control"
                     [(ngModel)]="currentCar.name"
                     name="editCarName"
                     [readonly]="loading.saving">
            </div>

            <div class="form-group">
              <label>Manufacturer:</label>
              <select class="form-control"
                      [(ngModel)]="selectedManufacturerId"
                      (ngModelChange)="onManufacturerChange($event)"
                      name="editManufacturer"
                      [disabled]="loading.saving">
                <option [ngValue]="0">Select manufacturer</option>
                <option *ngFor="let manufacturer of manufacturers"
                        [ngValue]="manufacturer.id">
                  {{manufacturer.name}}
                </option>
              </select>
            </div>

            <div class="form-group">
              <label>Model:</label>
              <select class="form-control"
                      [(ngModel)]="currentCar.model!.id"
                      name="editModel"
                      [disabled]="!selectedManufacturerId || loading.saving">
                <option [ngValue]="0">Select model</option>
                <option *ngFor="let model of models"
                        [ngValue]="model.id">
                  {{model.name}}
                </option>
              </select>
            </div>

            <div class="form-group">
              <label>Year:</label>
              <input class="form-control"
                     type="number"
                     [(ngModel)]="currentCar.year"
                     name="editYear"
                     [min]="1900"
                     [max]="currentYear"
                     [readonly]="loading.saving">
            </div>
          </div>

          <div class="col-md-6">
            <div class="form-group">
              <label>Engine Capacity (L):</label>
              <input class="form-control"
                     type="number"
                     [(ngModel)]="currentCar.engineCapacity"
                     name="editEngineCapacity"
                     step="0.1"
                     min="0.1"
                     max="10"
                     [readonly]="loading.saving">
            </div>

            <div class="form-group">
              <label>Fuel Type:</label>
              <select class="form-control"
                      [(ngModel)]="currentCar.fuelType"
                      name="editFuelType"
                      [disabled]="loading.saving">
                <option [ngValue]="null">Select fuel type</option>
                <option *ngFor="let type of fuelTypes"
                        [ngValue]="type">
                  {{getFuelTypeName(type)}}
                </option>
              </select>
            </div>

            <div class="form-group">
              <label>Transmission:</label>
              <select class="form-control"
                      [(ngModel)]="currentCar.transmission"
                      name="editTransmission"
                      [disabled]="loading.saving">
                <option [ngValue]="null">Select transmission</option>
                <option *ngFor="let type of transmissionTypes"
                        [ngValue]="type">
                  {{getTransmissionTypeName(type)}}
                </option>
              </select>
            </div>

            <div class="form-group">
              <label>Mileage (km):</label>
              <input class="form-control"
                     type="number"
                     [(ngModel)]="currentCar.mileage"
                     name="editMileage"
                     min="0"
                     [readonly]="loading.saving">
            </div>

            <div class="form-group">
              <label>Body Type:</label>
              <select class="form-control"
                      [(ngModel)]="currentCar.bodyID"
                      name="editBodyType"
                      [disabled]="loading.saving">
                <option [ngValue]="0">Select body type</option>
                <option *ngFor="let type of bodyTypes"
                        [ngValue]="type.id">
                  {{type.name}}
                </option>
              </select>
            </div>

            <div class="form-group">
              <label>City:</label>
              <select class="form-control"
                      [(ngModel)]="currentCar.cityID"
                      name="editCity"
                      [disabled]="loading.saving">
                <option [ngValue]="0">Select city</option>
                <option *ngFor="let city of cities"
                        [ngValue]="city.id"
                        [selected]="city.id === currentCar.cityID">
                  {{city.name}}
                </option>
              </select>
            </div>

            <div class="form-group">
              <label>Color:</label>
              <input class="form-control"
                     [(ngModel)]="currentCar.color"
                     name="editColor"
                     [readonly]="loading.saving">
            </div>

            <div class="form-group">
              <label>Fuel Consumption (L/100km):</label>
              <input class="form-control"
                     type="number"
                     [(ngModel)]="currentCar.fuelConsumption"
                     name="editFuelConsumption"
                     step="0.1"
                     min="0"
                     max="30"
                     [readonly]="loading.saving">
            </div>

            <div class="form-group">
              <label>Number of Doors:</label>
              <input class="form-control"
                     type="number"
                     [(ngModel)]="currentCar.doors"
                     name="editDoors"
                     min="2"
                     max="8"
                     [readonly]="loading.saving">
            </div>

            <div class="form-check">
              <input class="form-check-input"
                     type="checkbox"
                     [(ngModel)]="currentCar.hasServiceHistory"
                     name="editHasServiceHistory"
                     [disabled]="loading.saving">
              <label class="form-check-label">
                Has Service History
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading indicator -->
    <div *ngIf="advertisementId !== 0 && !currentCar" class="text-center p-3">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <!-- Form Actions -->
    <div class="form-actions mt-4">
      <button type="submit" class="btn btn-primary" [disabled]="isLoading">
        {{ isLoading ? 'Saving...' : (advertisementId === 0 ? 'Create Advertisement' : 'Update Advertisement') }}
      </button>
      <button type="button" class="btn btn-secondary ms-2" routerLink="/admin/advertisements">
        Cancel
      </button>
    </div>

    <!-- Error Message -->
    <div class="alert alert-danger mt-3" *ngIf="errorMessage">
      {{ errorMessage }}
    </div>
  </form>

  <!-- Images Section -->
  <div *ngIf="advertisementId" class="images-section mt-4">
    <h3>Advertisement Images</h3>
    <div class="image-grid">
      <div *ngFor="let image of advertisement.images" class="image-item">
        <img [src]="image.url" [alt]="advertisement.title" class="img-fluid">
        <div class="image-actions mt-2">
          <button class="btn btn-sm btn-primary me-2" *ngIf="!image.isPrimary"
                  (click)="setPrimaryImage(image.id)">
            Set as Primary
          </button>
          <button class="btn btn-sm btn-danger" (click)="deleteImage(image.id)">
            Delete
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
